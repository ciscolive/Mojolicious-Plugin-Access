package Mojolicious::Plugin::Access;

use Mojo::Base 'Mojolicious::Plugin';

sub register {
  my ( $self, $app, $opts ) = @_;
  Access: {
    $app->hook(
      before_dispatch => sub {
        my $c = shift;

        # 设定并读取白名单
        my %ipList;
        my $remoteList = $c->app->home->to_string . '/conf/.remote_access.conf';
        open IPFILE, "<$remoteList";
        while (<IPFILE>) {
          chomp;
          $ipList{$_} = 1;
        }
        close IPFILE;

        # 判定客户端地址是否有权限访问接口
        my $remote_ip = $c->tx->original_remote_address;
        unless (exists $ipList{$remote_ip}) {
          return $c->render(json => { 'code' => 403, 'message' => qq{Ip $remote_ip is forbidden} });
        }
      }
    );
  };
}

1;

1;
